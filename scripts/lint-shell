#!/usr/bin/env bash
#
# Lint shell scripts using shellcheck
#
# Usage: lint-shell [--exclude-tests]
#
# Must be run from the dotfiles root directory.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "${SCRIPT_DIR}")"

if [[ "$(pwd)" != "${PROJECT_ROOT}" ]]; then
  echo "Error: lint-shell must be run from the dotfiles directory" >&2
  echo "Usage: cd ${PROJECT_ROOT} && ./scripts/lint-shell" >&2
  exit 1
fi

if ! command -v shellcheck >/dev/null 2>&1; then
  echo "Error: shellcheck is not installed. Run: brew install shellcheck" >&2
  exit 1
fi

EXCLUDE_TESTS=false
if [[ "${1:-}" == "--exclude-tests" ]]; then
  EXCLUDE_TESTS=true
fi

EXIT_CODE=0

find_shell_scripts() {
  {
    find "${PROJECT_ROOT}" -type f \( -name "*.sh" -o -name "*.bash" \) 2>/dev/null || true

    if [[ "${EXCLUDE_TESTS}" = false ]]; then
      find "${PROJECT_ROOT}" -type f -name "*.bats" 2>/dev/null || true
    fi

    find "${PROJECT_ROOT}" -path "*/bin/.local/bin/*" -type f -perm +111 2>/dev/null | while read -r file; do
      if head -1 "${file}" 2>/dev/null | grep -qE "(bash|sh)" && ! head -1 "${file}" 2>/dev/null | grep -qE "(ruby|python|perl|fish)"; then
        echo "${file}"
      fi
    done || true
  } | grep -vE "(\.git/|/plugins/|node_modules/|vendor/)" || true
}

get_shell_type() {
  local file="$1"
  local shebang
  shebang=$(head -1 "${file}" 2>/dev/null || echo "")

  if [[ "${shebang}" == *"bash"* ]]; then echo "bash"
  elif [[ "${file}" == *.bats ]]; then echo "bash"
  elif [[ "${file}" == *.bash ]]; then echo "bash"
  elif [[ "${shebang}" == *"sh"* && "${shebang}" != *"fish"* ]]; then echo "sh"
  elif [[ "${file}" == *.sh ]]; then echo "sh"
  else echo "sh"
  fi
}

files=()
while IFS= read -r file; do
  files+=("${file}")
done < <(find_shell_scripts)

if [[ ${#files[@]} -eq 0 ]]; then
  echo "No shell scripts found to lint."
  exit 0
fi

echo "Linting ${#files[@]} shell script(s)..."

for file in "${files[@]}"; do
  shell_type=$(get_shell_type "${file}")
  if ! shellcheck --shell="${shell_type}" --format=gcc "${file}"; then
    EXIT_CODE=1
  fi
done

if [[ ${EXIT_CODE} -eq 0 ]]; then
  echo "All shell scripts passed linting."
fi

exit ${EXIT_CODE}
