#!/usr/bin/env bash
#
# Setup script for Claude Code Knowledge Base
# Creates directory structure and initializes git repository

set -euo pipefail

KB_PATH="${CLAUDE_KB_PATH:-${HOME}/claude-knowledge-base}"

# Create directory structure
echo "Setting up Claude Code Knowledge Base at: ${KB_PATH}"

mkdir -p "${KB_PATH}"/{topics/{development,troubleshooting,commands,tools,insights},sessions}

# Create README.md
cat > "${KB_PATH}/README.md" << 'EOF'
# Claude Code Knowledge Base

This is a personal knowledge base for capturing valuable insights, solutions, and discoveries from Claude Code sessions.

## Structure

- `topics/` - Categorized knowledge by domain
  - `development/` - Development tips, tricks, and solutions
  - `troubleshooting/` - Problem-solving and debugging insights
  - `commands/` - Useful commands and CLI tools
  - `tools/` - Tool configurations and usage
  - `insights/` - General insights and learnings
- `sessions/` - Session-based notes with timestamps
- `index.md` - Auto-generated index of all content

## Usage

From any Claude Code session:

```bash
# Save current conversation insights
/save-knowledge troubleshooting

# Save as session note
/save-knowledge --session-note

# Quick access to knowledge base
cdkb
```

## Navigation

- `cdkb` - Navigate to knowledge base
- `cdkb topics` - Go to topics directory
- `cdkb sessions` - Go to sessions directory

## Search

Use `rg` (ripgrep) to search across all knowledge:

```bash
cd $CLAUDE_KB_PATH
rg "search term" --type md
```
EOF

# Create initial index.md
cat > "${KB_PATH}/index.md" << 'EOF'
# Knowledge Base Index

*This file is auto-generated by the `/save-knowledge` command.*

## Recent Additions

<!-- Recent entries will be added here -->

## Topics

### Development
<!-- Development entries will be listed here -->

### Troubleshooting
<!-- Troubleshooting entries will be listed here -->

### Commands
<!-- Command entries will be listed here -->

### Tools
<!-- Tool entries will be listed here -->

### Insights
<!-- Insight entries will be listed here -->

## Sessions
<!-- Session notes will be listed here -->
EOF

# Initialize git repository
cd "${KB_PATH}"
if [ ! -d .git ]; then
    echo "Initializing git repository..."
    git init
    git add .
    git commit -m "Initial commit: Claude Code Knowledge Base setup"

    echo ""
    echo "âœ… Knowledge Base setup complete!"
    echo ""
    echo "Next steps:"
    echo "1. Create a private GitHub repository called 'claude-knowledge-base'"
    echo "2. Add the remote: git remote add origin <your-repo-url>"
    echo "3. Push: git push -u origin main"
    echo "4. Restart your shell or run: source ~/.zshrc (or exec fish)"
    echo "5. Test with: cdkb"
else
    echo "Git repository already exists"
fi

echo ""
echo "Knowledge Base ready at: ${KB_PATH}"
